{% extends 'base.html' %}
{% block title %}–†–µ–¥–∞–∫—Ç–æ—Ä –º–µ–Ω—é ‚Äî –ê–¥–º–∏–Ω{% endblock %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">–†–µ–¥–∞–∫—Ç–æ—Ä –º–µ–Ω—é</h1>
<p class="text-sm text-[color:var(--muted)] mb-6">–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å —Ä–∞–∑–¥–µ–ª—ã, –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã –∏ –ø–æ–∑–∏—Ü–∏–∏, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—ã –∏ —Ñ–ª–∞–≥–∏. –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π <code>data/menu.json</code>.</p>

<style>
  :root{--ctl-h:42px}
  .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:1rem}
  .line{border-color:rgba(255,255,255,.08)}
  .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.75rem;padding:0 .9rem;border:1px solid rgba(255,255,255,.12);min-height:var(--ctl-h)}
  .btn-accent{background:var(--accent);color:#000;border-color:var(--accent)}
  .btn-danger{border-color:#7f1d1d;color:#fecaca}
  .pill{border:1px solid rgba(255,255,255,.16);border-radius:9999px;padding:.25rem .6rem;font-size:.8rem}
  .k{color:var(--muted)}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.75rem}
  @media (max-width: 920px){.grid-3{grid-template-columns:1fr 1fr}}
  @media (max-width: 720px){.grid-2{grid-template-columns:1fr}}
  details>summary{cursor:pointer;list-style:none}
  details>summary::-webkit-details-marker{display:none}
  .handle{cursor:grab;user-select:none}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  /* —É–ª—É—á—à–µ–Ω–Ω–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏–Ω–ø—É—Ç–æ–≤/—Å–µ–ª–µ–∫—Ç–æ–≤ –Ω–∞ —Ç—ë–º–Ω–æ–º —Ñ–æ–Ω–µ */
  input, select, textarea{background:#0b0c10;color:#e8edf3;border:1px solid #2d3138;min-height:var(--ctl-h)}
  input::placeholder, textarea::placeholder{color:#a0a7b1;opacity:.9}
  select{appearance:auto}
  /* –∫–Ω–æ–ø–∫–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è */
  .toggle-sec,.toggle-sub{width:var(--ctl-h);justify-content:center;min-height:var(--ctl-h)}
  .hidden{display:none !important}
  /* icon picker */
  .icon-picker{position:relative}
  .icon-chip{display:flex;align-items:center;justify-content:space-between;gap:.75rem;border:1px solid #2d3138;border-radius:.75rem;padding:.5rem .75rem;background:#0b0c10;min-height:var(--ctl-h);width:100%}
  .icon-current{display:flex;align-items:center;gap:.5rem}
  .icon-picker-menu{position:absolute;z-index:50;top:calc(100% + 6px);left:0;background:#0b0c10;border:1px solid #2d3138;border-radius:.75rem;padding:.5rem;width:min(540px,90vw);max-height:280px;overflow:auto;display:none}
  .icon-option{display:flex;align-items:center;gap:.5rem;padding:.45rem .5rem;border-radius:.5rem;cursor:pointer}
  .icon-option:hover{background:#10141a}
  .icon-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.25rem}
  @media (min-width:640px){.icon-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .icon-picker .icon-svg{width:20px;height:20px;display:inline-flex}
</style>
<style>.card.dragging{opacity:.6}.handle:active{cursor:grabbing}</style>

<!-- –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ JSON (–∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏) -->
{% if menu_text is defined %}
  <script id="menu-data" type="text/plain">{{ menu_text|safe }}</script>
{% else %}
  <script id="menu-data" type="text/plain">{}</script>
{% endif %}
{% if menu_icons_text is defined %}
  <script id="menu-icons" type="text/plain">{{ menu_icons_text|safe }}</script>
{% else %}
  <script id="menu-icons" type="text/plain">{}</script>
{% endif %}

<form id="menuForm" method="post" class="space-y-6">
  <!-- —Å–∫—Ä—ã—Ç—ã–π textarea –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º -->
  <textarea name="menu_json" id="menu_json" class="hidden"></textarea>
  <!-- –∫–∞—Ä—Ç–∞ –∏–∫–æ–Ω–æ–∫ —Ä–∞–∑–¥–µ–ª–æ–≤ (section name -> icon id) -->
  <textarea name="menu_icons_json" id="menu_icons_json" class="hidden"></textarea>

  <div id="sections" class="space-y-4"></div>

  <div class="flex flex-wrap gap-3 mt-6">
    <button type="button" class="btn btn-accent" id="addSectionBtn">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª</button>
    <button type="submit" class="btn btn-accent">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button type="button" class="btn" id="exportBtn">‚§ì –ü–æ–∫–∞–∑–∞—Ç—å JSON</button>
    <button type="button" class="btn" id="collapseAll">‚àí –°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
    <button type="button" class="btn" id="expandAll">Ôºã –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
    <a href="{{ url_for('admin_dashboard') }}" class="btn">‚Üê –í –ø–∞–Ω–µ–ª—å</a>
  </div>

  <details class="mt-4">
    <summary class="text-sm underline">–ò–º–ø–æ—Ä—Ç –∏–∑ JSON</summary>
    <div class="mt-3 card p-3">
      <textarea id="import_json" class="w-full mono text-sm border rounded-xl p-3" rows="10" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ JSON –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä¬ª"></textarea>
      <div class="mt-3 flex gap-3">
        <button type="button" class="btn" id="importBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä</button>
      </div>
    </div>
  </details>

  <details class="mt-4">
    <summary class="text-sm underline">–¢–µ–∫—É—â–∏–π JSON</summary>
    <div class="mt-3 card p-3">
      <textarea id="export_json" class="w-full mono text-sm border rounded-xl p-3" rows="16" readonly></textarea>
    </div>
  </details>
</form>

<hr class="line my-8"/>

<section aria-labelledby="menu-images">
  <h2 class="text-xl font-semibold mb-3" id="menu-images">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –±–ª–æ–∫–∞ ¬´–ú–µ–Ω—é¬ª</h2>
  <p class="text-sm text-[color:var(--muted)] mb-3">–≠—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –º–æ–±–∏–ª—å–Ω–æ–º —Å–ª–∞–π–¥–µ—Ä–µ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ. –§–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ <code>static/menu/</code>.</p>

  <div class="card p-4">
    <form action="{{ url_for('admin_menu_upload') }}" method="post" enctype="multipart/form-data" class="flex flex-wrap items-center gap-3">
      <input type="file" name="images" multiple accept=".jpg,.jpeg,.png,.webp,.avif" class="border rounded-xl p-2.5"/>
      <button type="submit" class="btn btn-accent">‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      <span class="text-xs text-[color:var(--muted)]">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPG, PNG, WebP, AVIF</span>
    </form>

    <div id="menuGrid" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 gap-3">
      {% if menu_images and menu_images|length %}
        {% for img in menu_images %}
          <div class="card p-2 menu-card" data-name="{{ img.name }}">
            <img src="{{ img.url }}" alt="{{ img.name }}" class="w-full aspect-square object-cover rounded" loading="lazy"/>
            <div class="mt-2 flex items-center gap-2 text-xs">
              <span class="truncate flex-1" title="{{ img.name }}">{{ img.name }}</span>
              <label class="flex items-center gap-1 whitespace-nowrap">
                <span class="k">‚Ññ</span>
                <input type="number" step="1" class="order-input w-16 border rounded-xl p-1.5 text-sm" placeholder="‚Äî" value="{{ img.index if img.index is not none }}">
              </label>
              <form action="{{ url_for('admin_menu_delete') }}" method="post" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å {{ img.name }}?')">
                <input type="hidden" name="name" value="{{ img.name }}"/>
                <button type="submit" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
              </form>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-sm text-[color:var(--muted)]">–ü–æ–∫–∞ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ <code>static/menu/</code>.</div>
      {% endif %}
    </div>

    <div class="mt-4 flex items-center justify-between gap-3">
      <form id="imgOrderForm" action="{{ url_for('admin_menu_order') }}" method="post" class="flex items-center gap-3">
        <input type="hidden" name="indices" id="imgIndicesInput" value="{}">
        <input type="hidden" name="order" id="imgOrderInput" value="[]">
        <button id="autoNumberBtn" type="button" class="btn">123 –ê–≤—Ç–æ–Ω—É–º–µ—Ä–∞—Ü–∏—è</button>
        <button type="submit" class="btn btn-accent">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫</button>
      </form>
      <span class="text-xs text-[color:var(--muted)]">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ (1,2,3‚Ä¶) –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫¬ª.</span>
    </div>
  </div>
</section>

<template id="tmpl-section">
  <div class="card p-4 section" data-type="flat">
    <div class="flex items-center justify-between gap-3">
      <div class="flex-1 grid-3">
        <label class="block">
          <span class="text-sm k">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞</span>
          <input class="w-full border rounded-xl p-2.5 mt-1 section-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–∏–≤–æ –∏ —Å–∏–¥—Ä"/>
        </label>
        <label class="block">
          <span class="text-sm k">–§–æ—Ä–º–∞—Ç</span>
          <select class="w-full border rounded-xl p-2.5 mt-1 section-format">
            <option value="flat">–ë–µ–∑ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–æ–≤ (–ø—Ä–æ—Å—Ç–æ —Å–ø–∏—Å–æ–∫ –±–ª—é–¥)</option>
            <option value="subsections">–° –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞–º–∏</option>
          </select>
        </label>
        <label class="block">
          <span class="text-sm k">–ò–∫–æ–Ω–∫–∞</span>
          <div class="mt-1 icon-picker">
            <input type="hidden" class="section-icon" value="">
            <button type="button" class="icon-chip">
              <span class="icon-current"><span class="icon-svg"></span><span class="icon-label">–ê–≤—Ç–æ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é</span></span>
              <span class="k">‚ñæ</span>
            </button>
            <div class="icon-picker-menu">
              <div class="icon-grid"></div>
            </div>
          </div>
        </label>
      </div>
      <div class="flex items-center gap-2">
        <button type="button" class="btn toggle-sec" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚ñæ</button>
        <button type="button" class="btn handle sec-drag" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å">‚Üï</button>
        <button type="button" class="btn btn-danger del-section" title="–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>

    <div class="mt-4 sect-body">
      <!-- —Å—é–¥–∞ –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ª–∏–±–æ —Å–ø–∏—Å–æ–∫ items, –ª–∏–±–æ —Å–ø–∏—Å–æ–∫ subsections -->
    </div>

    <div class="mt-3 flex gap-2 add-row"></div>
  </div>
</template>

<template id="tmpl-items">
  <div class="items space-y-3">
  </div>
</template>

<template id="tmpl-item">
  <div class="card p-3 item">
    <div class="grid-2">
      <label class="block">
        <span class="text-sm k">–ù–∞–∑–≤–∞–Ω–∏–µ</span>
        <input class="w-full border rounded-xl p-2.5 mt-1 item-name" placeholder="–ù–∞–ø—Ä.: –ö–ª–∞—Å—Å–∏–∫"/>
      </label>
      <label class="block">
        <span class="text-sm k">–û–ø–∏—Å–∞–Ω–∏–µ</span>
        <input class="w-full border rounded-xl p-2.5 mt-1 item-desc" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ"/>
      </label>
    </div>
    <div class="mt-3 grid grid-cols-3 gap-3">
      <label class="block col-span-2">
        <span class="text-sm k">–í–∞—Ä–∏–∞–Ω—Ç—ã (–≤–µ—Å/–æ–±—ä—ë–º ‚Üí —Ü–µ–Ω–∞)</span>
        <div class="variants space-y-2 mt-1"></div>
        <button type="button" class="btn mt-2 add-variant">+ –í–∞—Ä–∏–∞–Ω—Ç</button>
      </label>
      <label class="block">
        <span class="text-sm k">–í –∫–æ—Ä–∑–∏–Ω—É</span>
        <div class="mt-2"><input type="checkbox" class="item-cart"> <span class="text-sm">–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</span></div>
      </label>
    </div>

    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ -->
    <div class="mt-3">
      <span class="text-sm k">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span>
      <div class="mt-2 flex items-start gap-3 item-image-row">
        <img class="item-image-preview w-20 h-20 object-cover rounded border border-[color:var(--line)]" alt="preview" style="display:none"/>
        <div class="space-y-2">
          <input type="hidden" class="item-image-url" value=""/>
          <input type="file" class="item-image-file" accept=".jpg,.jpeg,.png,.webp,.avif"/>
          <div class="flex gap-2">
            <button type="button" class="btn btn-accent item-image-upload">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            <button type="button" class="btn btn-danger item-image-delete">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
          <div class="text-xs text-[color:var(--muted)]">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è JPG, PNG, WebP, AVIF. <span class="item-image-fname"></span></div>
        </div>
      </div>
    </div>

    <div class="mt-3 flex gap-2 justify-end"><button type="button" class="btn handle item-drag" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å">‚Üï</button><button type="button" class="btn del-item btn-danger">–£–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button></div>
  </div>
</template>

<template id="tmpl-variant">
  <div class="grid grid-cols-3 gap-2 variant">
    <input class="border rounded-xl p-2.5 v-label" placeholder="–Ω–∞–ø—Ä.: 0.5 –ª / 250 –≥ / –ø—É—Å—Ç–æ"/>
    <input class="border rounded-xl p-2.5 v-price" type="number" step="0.01" min="0" placeholder="—Ü–µ–Ω–∞"/>
    <div class="flex items-center gap-2">
      <button type="button" class="btn del-variant btn-danger">‚Äî</button>
    </div>
  </div>
</template>

<template id="tmpl-subsections">
  <div class="subs space-y-3"></div>
</template>

<template id="tmpl-sub">
  <div class="card p-3 sub">
    <div class="flex items-center gap-3">
      <input class="border rounded-xl p-2.5 sub-name flex-1" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞ (–Ω–∞–ø—Ä.: –†–∞–∑–ª–∏–≤–Ω–æ–µ)"/>
      <div class="flex items-center gap-2">
        <button type="button" class="btn toggle-sub" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚ñæ</button>
        <button type="button" class="btn handle sub-drag" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å">‚Üï</button>
        <button type="button" class="btn del-sub btn-danger">–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª</button>
      </div>
    </div>
    <div class="mt-3 items space-y-3"></div>
    <div class="mt-3 add-item-row"><button type="button" class="btn add-item">+ –ü–æ–∑–∏—Ü–∏—è</button></div>
  </div>
</template>

<script>
(function(){
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const sectionsWrap = $('#sections');
  const jsonText = ($('#menu-data') ? $('#menu-data').textContent.trim() : '{}');
  const iconsText = ($('#menu-icons') ? $('#menu-icons').textContent.trim() : '{}');
  let data = {}; let iconsMap = {};
  try { data = JSON.parse(jsonText || '{}'); } catch(e){ console.error('JSON parse error', e); }
  try { iconsMap = JSON.parse(iconsText || '{}') || {}; } catch(e){ console.error('Icons JSON parse error', e); iconsMap = {}; }
  // –µ—Å–ª–∏ –≤ —Å–∞–º–æ–º –º–µ–Ω—é –ø—Ä–∏—à–ª–æ –ø–æ–ª–µ __icons__ ‚Äî —Å–ª–∏–≤–∞–µ–º –∏ —É–±–∏—Ä–∞–µ–º –∏–∑ –æ–±—ä–µ–∫—Ç–∞, —á—Ç–æ–±—ã –Ω–µ –ø–æ–ø–∞–ª–æ –∫–∞–∫ —Ä–∞–∑–¥–µ–ª
  if (data && typeof data==='object' && data.__icons__ && typeof data.__icons__==='object') {
    try { iconsMap = Object.assign({}, iconsMap, data.__icons__); delete data.__icons__; } catch(_) {}
  }

  const T = id => document.getElementById(id).content.firstElementChild.cloneNode(true);
  const DEFAULT_COLLAPSED = true;

  // ==== ICON PICKER DATA & HELPERS ====
  function iconSVG(id){
    switch(id){
      case 'beer': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M7 9v8a3 3 0 0 0 3 3h4a3 3 0 0 0 3-3V9"/><path d="M7 9h10v-1a3 3 0 0 0-3-3h-1.5"/><path d="M9 5c0 1.1-.9 2-2 2s-2-.9-2-2"/><path d="M17 11h2a2 2 0 0 0 0-4h-2"/></svg>`;
      case 'pint': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M7 3h10l-2 14a3 3 0 0 1-3 2.5A3 3 0 0 1 9 17L7 3Z"/></svg>`;
      case 'wheat': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 2v20"/><path d="M8 6l4 2 4-2"/><path d="M8 10l4 2 4-2"/><path d="M8 14l4 2 4-2"/></svg>`;
      case 'lager': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="5" y="3" width="14" height="18" rx="2"/></svg>`;
      case 'stout': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 3h10l-2 14a4 4 0 0 1-4 3 4 4 0 0 1-4-3L7 3Z"/></svg>`;
      case 'ipa': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 2v8"/><circle cx="12" cy="14" r="4"/></svg>`;
      case 'cider': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="7"/><path d="M9 10c1-2 5-2 6 0"/></svg>`;
      case 'wine': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M8 4h8l-1 6a5 5 0 1 1-6 0L8 4Z"/><path d="M12 15v5"/></svg>`;
      case 'red_wine': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 4h8l-1 6a5 5 0 1 1-6 0L8 4Z"/><path d="M12 15v5" fill="none" stroke="currentColor" stroke-width="1.8"/></svg>`;
      case 'white_wine': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M8 4h8l-1 6a5 5 0 1 1-6 0L8 4Z"/><path d="M12 15v5"/></svg>`;
      case 'cocktail': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 4h18L12 12 3 4Z"/><path d="M12 12v8"/></svg>`;
      case 'martini': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M2 4h20L12 12 2 4Z"/><path d="M12 12v8"/></svg>`;
      case 'mojito': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="7" y="2" width="10" height="20" rx="2"/><path d="M9 7l6 6"/></svg>`;
      case 'shot': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M7 4h10l-2 14H9L7 4Z"/></svg>`;
      case 'soft': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M6 3h12l-2 16a3 3 0 0 1-3 2H11a3 3 0 0 1-3-2L6 3Z"/></svg>`;
      case 'coffee': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 8h13a4 4 0 0 1 0 8H6a3 3 0 0 1-3-3V8Z"/><path d="M16 8v3a2 2 0 0 0 2 2h1"/></svg>`;
      case 'tea': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 10h14v3a4 4 0 0 1-4 4H8a4 4 0 0 1-4-4v-3Z"/><path d="M18 10h2a2 2 0 0 1 0 4h-2"/></svg>`;
      case 'lemonade': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="7" y="3" width="10" height="18" rx="2"/><path d="M9 7h6"/></svg>`;
      case 'juice': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="6"/></svg>`;
      case 'water': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 2s6 7 6 11a6 6 0 0 1-12 0c0-4 6-11 6-11Z"/></svg>`;
      case 'snack': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 15h16M6 11h12M8 7h8"/></svg>`;
      case 'fries': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M5 7h14l-2 13H7L5 7Z"/><path d="M8 7V3M12 7V2M16 7V4"/></svg>`;
      case 'wings': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 12s4-6 8-6 8 6 8 6-4 6-8 6-8-6-8-6Z"/></svg>`;
      case 'ribs': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="8" width="18" height="8" rx="2"/></svg>`;
      case 'cheese_sticks': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="4" y="10" width="16" height="4" rx="1"/><path d="M8 7l8 10"/></svg>`;
      case 'nuggets': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><circle cx="8" cy="12" r="3"/><circle cx="16" cy="12" r="3"/></svg>`;
      case 'bruschetta': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="10" width="18" height="6" rx="2"/><path d="M6 10V8a3 3 0 0 1 3-3h6a3 3 0 0 1 3 3v2"/></svg>`;
      case 'burger': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 10a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4H4Z"/><path d="M3 13h18"/><path d="M4 16a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3H4Z"/></svg>`;
      case 'hotdog': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="9" width="18" height="6" rx="3"/><path d="M7 9c2 2 8 2 10 0"/></svg>`;
      case 'pizza': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 3 21 21H3L12 3Z"/><circle cx="12" cy="14" r="1"/><circle cx="9" cy="12" r="1"/></svg>`;
      case 'steak': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 12c0-4 4-7 8-7s8 3 8 7-4 7-8 7-8-3-8-7Z"/><circle cx="12" cy="12" r="2"/></svg>`;
      case 'fish': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 12s4-4 9-4 9 4 9 4-4 4-9 4-9-4-9-4Z"/><circle cx="7" cy="12" r="1"/></svg>`;
      case 'shrimp': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 12h10a5 5 0 1 0 0-10H8a5 5 0 0 0 0 10h5"/></svg>`;
      case 'salad': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 12a8 8 0 0 0 16 0H4Z"/><path d="M12 4v4"/></svg>`;
      case 'soup': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 12h16v2a6 6 0 0 1-6 6H10a6 6 0 0 1-6-6v-2Z"/><path d="M7 8h10"/></svg>`;
      case 'pasta': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 12h16M4 16h16M4 8h16"/></svg>`;
      case 'pan': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="9" cy="12" r="5"/><path d="M14 12h7"/></svg>`;
      case 'bowl': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 10a8 8 0 0 0 16 0H4Z"/></svg>`;
      case 'bread': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 12a6 6 0 0 1 6-6h6a6 6 0 0 1 6 6v6H3v-6Z"/></svg>`;
      case 'dessert': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 3v4"/><path d="M4 12h16l-2 6H6l-2-6Z"/></svg>`;
      case 'cake': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 12h18v7H3v-7Z"/><path d="M12 3v4"/></svg>`;
      case 'icecream': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M8 10a4 4 0 1 1 8 0v1H8v-1Z"/><path d="M9 11l3 8 3-8"/></svg>`;
      case 'waffle': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 4v16M12 4v16M16 4v16M4 8h16M4 12h16M4 16h16"/></svg>`;
      case 'kids': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="8" r="3"/><path d="M5 21v-2a7 7 0 0 1 14 0v2"/></svg>`;
      case 'spicy': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 2s6 4 6 10a6 6 0 0 1-12 0C6 6 12 2 12 2Z"/></svg>`;
      case 'vegan': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 21S9 3 21 3c0 12-18 18-18 18Z"/></svg>`;
      case 'veg': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="8"/></svg>`;
      case 'gluten_free': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="9"/><path d="M4 4l16 16"/></svg>`;
      case 'star': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z"/></svg>`;
      case 'new': return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="3"/></svg>`;
      case 'default':
      default:
        return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="8"/></svg>`;
    }
  }
  const ICONS = [
    {id:'', label:'–ê–≤—Ç–æ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é'},
    {id:'beer', label:'–ü–∏–≤–æ ‚Äî –±–æ–∫–∞–ª'},
    {id:'pint', label:'–ü–∏–≤–æ ‚Äî –ø–∏–Ω—Ç–∞'},
    {id:'wheat', label:'–ü—à–µ–Ω–∏—á–Ω–æ–µ'},
    {id:'lager', label:'–õ–∞–≥–µ—Ä'},
    {id:'stout', label:'–°—Ç–∞—É—Ç'},
    {id:'ipa', label:'IPA'},
    {id:'cider', label:'–°–∏–¥—Ä'},
    {id:'wine', label:'–í–∏–Ω–æ'},
    {id:'red_wine', label:'–í–∏–Ω–æ –∫—Ä–∞—Å–Ω–æ–µ'},
    {id:'white_wine', label:'–í–∏–Ω–æ –±–µ–ª–æ–µ'},
    {id:'cocktail', label:'–ö–æ–∫—Ç–µ–π–ª—å'},
    {id:'martini', label:'–ú–∞—Ä—Ç–∏–Ω–∏'},
    {id:'mojito', label:'–ú–æ—Ö–∏—Ç–æ'},
    {id:'shot', label:'–®–æ—Ç—ã'},
    {id:'soft', label:'–ë–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–µ'},
    {id:'coffee', label:'–ö–æ—Ñ–µ'},
    {id:'tea', label:'–ß–∞–π'},
    {id:'lemonade', label:'–õ–∏–º–æ–Ω–∞–¥—ã'},
    {id:'juice', label:'–°–æ–∫'},
    {id:'water', label:'–í–æ–¥–∞'},
    {id:'snack', label:'–ó–∞–∫—É—Å–∫–∏'},
    {id:'fries', label:'–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å —Ñ—Ä–∏'},
    {id:'wings', label:'–ö—Ä—ã–ª—ã—à–∫–∏'},
    {id:'ribs', label:'–†—ë–±—Ä–∞'},
    {id:'cheese_sticks', label:'–°—ã—Ä–Ω—ã–µ –ø–∞–ª–æ—á–∫–∏'},
    {id:'nuggets', label:'–ù–∞–≥–≥–µ—Ç—Å—ã'},
    {id:'bruschetta', label:'–ë—Ä—É—Å–∫–µ—Ç—Ç—ã'},
    {id:'burger', label:'–ë—É—Ä–≥–µ—Ä'},
    {id:'hotdog', label:'–•–æ—Ç-–¥–æ–≥'},
    {id:'pizza', label:'–ü–∏—Ü—Ü–∞'},
    {id:'steak', label:'–°—Ç–µ–π–∫'},
    {id:'fish', label:'–†—ã–±–∞'},
    {id:'shrimp', label:'–ö—Ä–µ–≤–µ—Ç–∫–∏'},
    {id:'salad', label:'–°–∞–ª–∞—Ç—ã'},
    {id:'soup', label:'–°—É–ø—ã'},
    {id:'pasta', label:'–ü–∞—Å—Ç–∞'},
    {id:'pan', label:'–°–∫–æ–≤–æ—Ä–æ–¥–∫–∏'},
    {id:'bowl', label:'–ë–æ—É–ª/–ü–æ–∫–µ'},
    {id:'bread', label:'–•–ª–µ–±'},
    {id:'dessert', label:'–î–µ—Å–µ—Ä—Ç—ã'},
    {id:'cake', label:'–¢–æ—Ä—Ç'},
    {id:'icecream', label:'–ú–æ—Ä–æ–∂–µ–Ω–æ–µ'},
    {id:'waffle', label:'–í–∞—Ñ–ª–∏'},
    {id:'kids', label:'–î–µ—Ç—Å–∫–æ–µ'},
    {id:'spicy', label:'–û—Å—Ç—Ä–æ–µ'},
    {id:'vegan', label:'–í–µ–≥–∞–Ω'},
    {id:'veg', label:'–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–æ–µ'},
    {id:'gluten_free', label:'–ë–µ–∑ –≥–ª—é—Ç–µ–Ω–∞'},
    {id:'star', label:'–•–∏—Ç'},
    {id:'new', label:'–ù–æ–≤–∏–Ω–∫–∞'},
    {id:'default', label:'–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é'}
  ];
  function initIconPicker(sect, current){
    const pick = sect.querySelector('.icon-picker');
    if(!pick) return;
    const hidden = pick.querySelector('input.section-icon');
    const chip = pick.querySelector('.icon-chip');
    const label = pick.querySelector('.icon-label');
    const svgWrap = pick.querySelector('.icon-svg');
    const menu = pick.querySelector('.icon-picker-menu');
    const grid = pick.querySelector('.icon-grid');
    function renderChip(id){
      const meta = ICONS.find(x=>x.id===id) || ICONS[0];
      svgWrap.innerHTML = iconSVG(id||'default');
      label.textContent = meta ? meta.label : '–ê–≤—Ç–æ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é';
    }
    function close(){ menu.style.display='none'; document.removeEventListener('click', onDoc); }
    function onDoc(e){ if(!pick.contains(e.target)){ close(); } }
    function open(){ menu.style.display='block'; setTimeout(()=>document.addEventListener('click', onDoc),0); }
    grid.innerHTML = '';
    ICONS.forEach(function(opt){
      const d = document.createElement('div'); d.className='icon-option'; d.dataset.value = opt.id;
      d.innerHTML = `<span class="icon-svg">${iconSVG(opt.id||'default')}</span><span>${opt.label}</span>`;
      d.addEventListener('click', function(){ hidden.value = opt.id; renderChip(opt.id); close(); updateExport(); });
      grid.appendChild(d);
    });
    chip.addEventListener('click', function(){ if(menu.style.display==='block') close(); else open(); });
    hidden.value = current || '';
    renderChip(current || '');
  }

  // --- Helpers: preview JSON ---
  function setExportRaw(txt){
    const area = document.getElementById('export_json');
    if (area) area.value = (txt && txt.trim()) ? txt : '{}';
  }
  function updateExport(){
    const area = document.getElementById('export_json');
    if (!area) return;
    try { area.value = JSON.stringify(serialize(), null, 2); } catch { area.value = '{}'; }
  }

  // --- Drag & Drop (sections / subsections / items) ---
  let dragging = null, dragSrc = null, dragType = null;
  function clearDragging(){
    $$('.card.dragging').forEach(function(el){ el.classList.remove('dragging'); });
        dragging = null; dragSrc = null; dragType = null;
  }
  // global safety: always clear dragging state at the end of DnD (some browsers don't bubble dragend)
  document.addEventListener('dragend', function(){
    clearDragging(); updateExport();
  }, true);
  document.addEventListener('drop', function(){
    clearDragging();
  }, true);
  function makeSortable(container, itemSelector, handleSelector){
        container.addEventListener('dragstart', function(e){
      const item = e.target.closest(itemSelector);
      if (!item || !e.target.closest(handleSelector)) { e.preventDefault(); return; }
      dragging = item;
      dragSrc = item.parentElement;
      dragType = itemSelector;
      item.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      try{ e.dataTransfer.setData('text/plain','drag'); }catch(_){ }
    }, true);

    container.addEventListener('dragend', function(){
      clearDragging(); updateExport();
    }, true);

    container.addEventListener('dragover', function(e){
      if(!dragging || dragType !== itemSelector) return;
      e.preventDefault();
      if (dragging.contains(container)) return; // avoid inserting parent into its child
      const after = getDragAfterElement(container, e.clientY, itemSelector);
      if (after==null) container.appendChild(dragging); else container.insertBefore(dragging, after);
    });

    container.addEventListener('dragenter', function(e){ if(dragging && dragType === itemSelector){ e.preventDefault(); } });

    container.addEventListener('drop', function(e){ if(dragging && dragType === itemSelector){ e.preventDefault(); clearDragging(); } });
  }
  function getDragAfterElement(container, y, itemSelector){
    const els = Array.from(container.querySelectorAll(itemSelector+':not(.dragging)'));
    let closest = null; let closestOffset = Number.NEGATIVE_INFINITY;
    for (var i=0;i<els.length;i++){
      const el = els[i];
      const box = el.getBoundingClientRect();
      const offset = y - (box.top + box.height/2);
      if (offset < 0 && offset > closestOffset){ closestOffset = offset; closest = el; }
    }
    return closest;
  }

  // enable sorting of sections
  makeSortable(sectionsWrap, '.section', '.handle');

  // –ø–µ—Ä–≤–∏—á–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é JSON
  setExportRaw(jsonText);

  // --- UI builders ---
  function createVariantRow(root, v){
    const row = T('tmpl-variant');
    const vv = v || {label:'', price:''};
    $('.v-label', row).value = (vv.label != null ? vv.label : '');
    $('.v-price', row).value = (vv.price != null ? vv.price : '');
    $('.del-variant', row).addEventListener('click', function(){ row.remove(); });
    $('.v-price', row).addEventListener('input', function(e){ var x=parseFloat(String(e.target.value).replace(',','.')); if(isNaN(x)){return;} e.target.value = x; });
    $('.variants', root).appendChild(row);
  }

  function createItemCard(container, item){
    const card = T('tmpl-item');
    card.draggable = true; var h1 = $('.handle', card); if (h1) h1.draggable = true;
    const it = item || {name:'', desc:'', variants:[{label:'',price:''}], add_to_cart:true, image:''};
    $('.item-name', card).value = it.name || '';
    $('.item-desc', card).value = it.desc || '';
    $('.item-cart', card).checked = !!it.add_to_cart;
    // variants
    (it.variants && it.variants.length ? it.variants : [{label:'',price:''}]).forEach(function(v){ createVariantRow(card, v); });
    $('.add-variant', card).addEventListener('click', function(){ createVariantRow(card); });
    $('.del-item', card).addEventListener('click', function(){ card.remove(); });

    // image hydrate
    const urlInput = $('.item-image-url', card);
    const prev = $('.item-image-preview', card);
    const fname = $('.item-image-fname', card);
    const fileInput = $('.item-image-file', card);
    const btnUp = $('.item-image-upload', card);
    const btnDel = $('.item-image-delete', card);

    function toDisplayURL(path){
      if (!path) return '';
      if (/^https?:\/\//i.test(path)) return path;
      if (path.startsWith('/')) return path;
      return '/static/' + path.replace(/^\/+/, '');
    }
    function setImage(path){
      urlInput.value = path || '';
      const show = !!path;
      const src = toDisplayURL(path||'');
      prev.style.display = show ? '' : 'none';
      prev.src = show ? src : '';
      fname.textContent = show ? path : '';
    }
    setImage(it.image || '');

    btnUp.addEventListener('click', async function(){
      const file = fileInput.files && fileInput.files[0];
      if(!file){ alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'); return; }
      // —Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç (–ø–æ –∏–º–µ–Ω–∞–º –∏ –∏–Ω–¥–µ–∫—Å–∞–º)
      const sect = card.closest('.section');
      const sub = card.closest('.sub');
      const sectionName = sect ? $('.section-name', sect).value : '';
      const subsectionName = sub ? $('.sub-name', sub).value : '';
      const itemName = $('.item-name', card).value || '';
      const sectionIdx = Array.from(sectionsWrap.children).indexOf(sect);
      const subIdx = sub ? Array.from(sect.querySelectorAll('.sub')).indexOf(sub) : -1;
      const itemIdx = Array.from(card.parentElement.children).indexOf(card);

      const fd = new FormData();
      fd.append('image', file);
      fd.append('section', sectionName);
      fd.append('subsection', subsectionName);
      fd.append('item_name', itemName);
      fd.append('section_idx', String(sectionIdx));
      fd.append('sub_idx', String(subIdx));
      fd.append('item_idx', String(itemIdx));

      try{
        const r = await fetch('/admin/menu/item-image/upload', { method:'POST', body: fd });
        if(!r.ok){ throw new Error('HTTP '+r.status); }
        const js = await r.json();
        if(js && js.ok){ setImage(js.path || js.image || js.image_path || ''); updateExport(); }
        else{ alert(js && js.error ? js.error : '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'); }
      }catch(e){
        console.error(e);
        alert('–°–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É (–Ω–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞ /admin/menu/item-image/upload). –û—Ç–∫—Ä–æ–π—Ç–µ app.py ‚Äî —è –¥–æ–±–∞–≤–ª—é –±—ç–∫–µ–Ω–¥.');
      }
    });

    btnDel.addEventListener('click', async function(){
      if(!urlInput.value){ setImage(''); updateExport(); return; }
      const sect = card.closest('.section');
      const sub = card.closest('.sub');
      const sectionName = sect ? $('.section-name', sect).value : '';
      const subsectionName = sub ? $('.sub-name', sub).value : '';
      const itemName = $('.item-name', card).value || '';
      try{
        const r = await fetch('/admin/menu/item-image/delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
          image: urlInput.value,
          section: sectionName,
          subsection: subsectionName,
          item_name: itemName
        })});
        if(!r.ok){ throw new Error('HTTP '+r.status); }
        const js = await r.json();
        if(js && js.ok){ setImage(''); updateExport(); }
        else{ alert(js && js.error ? js.error : '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'); }
      }catch(e){
        console.error(e);
        alert('–°–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ (–Ω–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞ /admin/menu/item-image/delete). –û—Ç–∫—Ä–æ–π—Ç–µ app.py ‚Äî —è –¥–æ–±–∞–≤–ª—é –±—ç–∫–µ–Ω–¥.');
      }
    });

    container.appendChild(card);
  }

  function createSubCard(container, name, items) {
    const sub = T('tmpl-sub');
    sub.draggable = true; var h2 = $('.handle', sub); if (h2) h2.draggable = true;
    $('.sub-name', sub).value = name || '';
    const itemsWrap = $('.items', sub);
    makeSortable(itemsWrap, '.item', '.handle');
    const addItemRow = $('.add-item-row', sub);
    if (DEFAULT_COLLAPSED){ itemsWrap.classList.add('hidden'); addItemRow.classList.add('hidden'); }
    (items||[]).forEach(function(it){ createItemCard(itemsWrap, it); });
    $('.add-item', sub).addEventListener('click', function(){ createItemCard(itemsWrap); });
    $('.del-sub', sub).addEventListener('click', function(){ sub.remove(); });
    $('.toggle-sub', sub).addEventListener('click', function(){ itemsWrap.classList.toggle('hidden'); addItemRow.classList.toggle('hidden'); });
    container.appendChild(sub);
  }

  function createSectionCard(name, value){
    const sect = T('tmpl-section');
    sect.draggable = true; var h3 = $('.handle', sect); if (h3) h3.draggable = true;
    $('.section-name', sect).value = name || '';
    const body = $('.sect-body', sect);
    const addRow = $('.add-row', sect);

    const isSubs = value && typeof value === 'object' && value.subsections;
    const iconSel = $('.section-icon', sect);
    const initialIcon = (iconsMap && iconsMap[name]) ? String(iconsMap[name]) : ((value && typeof value==='object' && value.icon) ? String(value.icon) : '');
    if (iconSel) iconSel.value = initialIcon;
    initIconPicker(sect, initialIcon);
    $('.section-format', sect).value = isSubs ? 'subsections' : 'flat';

    function mountFlat(items){
      body.innerHTML = '';
      const itemsRoot = T('tmpl-items');
      body.appendChild(itemsRoot);
      makeSortable(itemsRoot, '.item', '.handle');
      addRow.innerHTML = '';
      const addBtn = document.createElement('button'); addBtn.type='button'; addBtn.className='btn'; addBtn.textContent='+ –ü–æ–∑–∏—Ü–∏—è';
      addBtn.addEventListener('click', function(){ createItemCard(itemsRoot); });
      addRow.appendChild(addBtn);
      (Array.isArray(items)? items:[]).forEach(function(it){ createItemCard(itemsRoot, it); });
      sect.dataset.type = 'flat';
    }

    function mountSubs(subsections){
      body.innerHTML='';
      const subsRoot = T('tmpl-subsections');
      body.appendChild(subsRoot);
      makeSortable(subsRoot, '.sub', '.handle');
      addRow.innerHTML='';
      const addSub = document.createElement('button'); addSub.type='button'; addSub.className='btn'; addSub.textContent='+ –ü–æ–¥—Ä–∞–∑–¥–µ–ª';
      addSub.addEventListener('click', function(){ createSubCard(subsRoot); });
      addRow.appendChild(addSub);
      if(subsections && typeof subsections==='object'){
        Object.keys(subsections).forEach(function(sname){ createSubCard(subsRoot, sname, subsections[sname]); });
      }
      sect.dataset.type = 'subsections';
    }

    if(isSubs){ mountSubs(value.subsections); } else { mountFlat(Array.isArray(value)? value : []); }

    if (DEFAULT_COLLAPSED) { body.classList.add('hidden'); addRow.classList.add('hidden'); }

    $('.section-format', sect).addEventListener('change', function(e){ if(e.target.value==='flat') mountFlat([]); else mountSubs({}); });
    $('.toggle-sec', sect).addEventListener('click', function(){ body.classList.toggle('hidden'); addRow.classList.toggle('hidden'); });
    $('.del-section', sect).addEventListener('click', function(){ sect.remove(); });

    sectionsWrap.appendChild(sect);
  }

  function hydrateFromData(obj){
    sectionsWrap.innerHTML='';
    Object.keys(obj||{}).forEach(function(name){
      if (name === '__icons__') return; // –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–º —Å–ª—É–∂–µ–±–Ω—ã–π –∫–ª—é—á
      createSectionCard(name, obj[name]);
    });
  }

  function serialize(){
    const out = {};
    $$('.section', sectionsWrap).forEach(function(sect){
      const name = ($('.section-name', sect).value || '').trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      const type = $('.section-format', sect).value;
      const icon = ($('.section-icon', sect) && $('.section-icon', sect).value) || '';
      if(type==='flat'){
        const items=[];
        $$('.item', sect).forEach(function(it){
          const item={ name: ($('.item-name', it).value||'').trim(), desc: ($('.item-desc', it).value||'').trim() };
          (function(){ const p= $('.item-image-url', it); const val = p ? (p.value||'').trim():''; if(val) item.image = val; })();
          item.add_to_cart = $('.item-cart', it).checked;
          const vars=[]; $$('.variant', it).forEach(function(v){
            const label=($('.v-label', v).value||'').trim();
            const price=parseFloat((($('.v-price', v).value)||'').toString().replace(',','.'));
            if(!isNaN(price)) vars.push({label:label, price:price});
          });
          if(vars.length>0) item.variants = vars; else delete item.variants;
          items.push(item);
        });
        out[name] = items; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞–∫ —Å–ø–∏—Å–æ–∫ (–Ω–µ –ª–æ–º–∞–µ–º —Ñ—Ä–æ–Ω—Ç)
        if (icon) {
          if (!out.__icons__) out.__icons__ = {};
          out.__icons__[name] = icon;
        }
      } else {
        const subs={};
        $$('.sub', sect).forEach(function(sub){
          const sname = ($('.sub-name', sub).value||'').trim() || '–ü–æ–¥—Ä–∞–∑–¥–µ–ª';
          const items=[]; $$('.item', sub).forEach(function(it){
            const item={ name: ($('.item-name', it).value||'').trim(), desc: ($('.item-desc', it).value||'').trim() };
            (function(){ const p= $('.item-image-url', it); const val = p ? (p.value||'').trim():''; if(val) item.image = val; })();
            item.add_to_cart = $('.item-cart', it).checked;
            const vars=[]; $$('.variant', it).forEach(function(v){
              const label=($('.v-label', v).value||'').trim();
              const price=parseFloat((($('.v-price', v).value)||'').toString().replace(',','.'));
              if(!isNaN(price)) vars.push({label:label, price:price});
            });
            if(vars.length>0) item.variants = vars; else delete item.variants;
            items.push(item);
          });
          subs[sname]=items;
        });
        out[name] = { subsections: subs };
        if (icon) {
          if (!out.__icons__) out.__icons__ = {};
          out.__icons__[name] = icon;
        }
      }
    });
    return out;
  }

  // --- Init ---
  hydrateFromData(data);
  updateExport();

  // Fallback from API
  (async function ensureData(){
    try{
      if (data && Object.keys(data||{}).length) return;
      const r = await fetch('/api/menu', {headers:{'Accept':'application/json'}});
      if (!r.ok) return;
      const js = await r.json();
      if (js && typeof js==='object' && Object.keys(js).length){
        // –¥–æ—Å—Ç–∞–Ω–µ–º –∏–∫–æ–Ω–∫–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
        if (js.__icons__ && typeof js.__icons__==='object'){
          try { iconsMap = Object.assign({}, iconsMap, js.__icons__); delete js.__icons__; } catch(_) {}
        }
        data = js; setExportRaw(JSON.stringify(js, null, 2)); hydrateFromData(data); updateExport();
      }
    }catch(e){ console.warn('Fallback /api/menu failed', e); }
  })();

  // Fallback #2 from textarea
  setTimeout(function(){
    if (!sectionsWrap.children.length){
      try{
        const area = document.getElementById('export_json');
        const raw = area ? area.value : '';
        if (raw && raw.trim()){
          const obj = JSON.parse(raw);
          if (obj && typeof obj==='object' && obj.__icons__) { try { iconsMap = Object.assign({}, iconsMap, obj.__icons__); delete obj.__icons__; } catch(_) {} }
          hydrateFromData(obj);
          updateExport();
        }
      }catch(e){ /* ignore */ }
    }
  }, 0);

  // live preview update
  sectionsWrap.addEventListener('input', function(){ setTimeout(updateExport, 0); });
  sectionsWrap.addEventListener('change', function(){ setTimeout(updateExport, 0); });
  sectionsWrap.addEventListener('click', function(e){ if (e.target && (e.target.matches('button') || e.target.closest('button'))) setTimeout(updateExport, 0); });

  document.getElementById('addSectionBtn').addEventListener('click', function(){ createSectionCard('', []); updateExport(); });
  document.getElementById('collapseAll').addEventListener('click', function(){
    $$('.sect-body', sectionsWrap).forEach(function(el){ el.classList.add('hidden'); });
    $$('.add-row', sectionsWrap).forEach(function(el){ el.classList.add('hidden'); });
    $$('.sub .items', sectionsWrap).forEach(function(el){ el.classList.add('hidden'); });
    $$('.sub .add-item-row', sectionsWrap).forEach(function(el){ el.classList.add('hidden'); });
  });
  document.getElementById('expandAll').addEventListener('click', function(){
    $$('.sect-body', sectionsWrap).forEach(function(el){ el.classList.remove('hidden'); });
    $$('.add-row', sectionsWrap).forEach(function(el){ el.classList.remove('hidden'); });
    $$('.sub .items', sectionsWrap).forEach(function(el){ el.classList.remove('hidden'); });
    $$('.sub .add-item-row', sectionsWrap).forEach(function(el){ el.classList.remove('hidden'); });
  });

  document.getElementById('menuForm').addEventListener('submit', function(){
    const obj = serialize();
    // –≤—ã–Ω–µ—Å–µ–º –∫–∞—Ä—Ç—É –∏–∫–æ–Ω–æ–∫ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ —Ñ–æ—Ä–º—ã, —á—Ç–æ–±—ã –±—ç–∫–µ–Ω–¥ –º–æ–≥ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –µ—ë –æ—Ç–¥–µ–ª—å–Ω–æ –∏ –Ω–µ –ª–æ–º–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É menu.json
    const icons = obj.__icons__ || {};
    if ('__icons__' in obj) delete obj.__icons__;
    document.getElementById('menu_json').value = JSON.stringify(obj, null, 2);
    document.getElementById('menu_icons_json').value = JSON.stringify(icons, null, 2);
  });

  document.getElementById('exportBtn').addEventListener('click', function(){
    updateExport();
    const detWrap = document.getElementById('export_json');
    if (detWrap){ var det = detWrap.closest('details'); if (det) det.open = true; }
  });

  document.getElementById('importBtn').addEventListener('click', function(){
    try{
      const val = (document.getElementById('import_json').value || '').trim();
      if(!val) return;
      const obj = JSON.parse(val);
      if (obj && typeof obj==='object' && obj.__icons__) { try { iconsMap = Object.assign({}, iconsMap, obj.__icons__); delete obj.__icons__; } catch(_) {} }
      hydrateFromData(obj);
      updateExport();
    } catch(err){ alert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: '+ err.message); }
  });
})();
</script>
<script>
// –ü–æ—Ä—è–¥–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º (–±–µ–∑ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è)
(function(){
  const grid = document.getElementById('menuGrid');
  const form = document.getElementById('imgOrderForm');
  const auto = document.getElementById('autoNumberBtn');
  const hidden = document.getElementById('imgIndicesInput');
  const orderHidden = document.getElementById('imgOrderInput');
  if(!grid || !form || !hidden || !orderHidden) return;

  form.addEventListener('submit', function(){
    const map = {};
    const rows = Array.from(grid.querySelectorAll('.menu-card'));
    // —Å–æ–±—Ä–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã
    rows.forEach(function(card){
      const name = card.dataset.name;
      const inp = card.querySelector('.order-input');
      if(!name || !inp) return;
      const raw = String(inp.value || '').trim();
      if(raw==='') return;
      const v = Number(raw);
      if(!Number.isNaN(v)) map[name] = v;
    });
    hidden.value = Object.keys(map).length ? JSON.stringify(map) : '{}';

    // –ø–æ—Å—Ç—Ä–æ–∏—Ç—å order-–º–∞—Å—Å–∏–≤ (—Ñ–æ–ª–±—ç–∫ –¥–ª—è –±—ç–∫–µ–Ω–¥–∞): –µ—Å–ª–∏ –µ—Å—Ç—å –∏–Ω–¥–µ–∫—Å—ã ‚Äî —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–∏–º, –∏–Ω–∞—á–µ –ø–æ —Ç–µ–∫—É—â–µ–º—É DOM
    let names;
    if (Object.keys(map).length){
      names = rows.map(c=>c.dataset.name).sort(function(a,b){
        const av = (a in map) ? map[a] : Number.POSITIVE_INFINITY;
        const bv = (b in map) ? map[b] : Number.POSITIVE_INFINITY;
        if (av === bv) return a.localeCompare(b);
        return av - bv;
      });
    } else {
      names = rows.map(c=>c.dataset.name);
    }
    orderHidden.value = JSON.stringify(names);
  });

  if (auto){
    auto.addEventListener('click', function(){
      let n = 1;
      grid.querySelectorAll('.order-input').forEach(function(inp){ inp.value = n; n += 1; });
    });
  }
})();
</script>
{% endblock %}
