{% extends 'base.html' %}
{% block title %}–ö–æ—Ä–∑–∏–Ω–∞ ‚Äî {{ site.name or '–°–∞–π—Ç' }}{% endblock %}
{% block content %}

<style>
  .card{ background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); }
  .sticky-summary{ position:sticky; top:calc(var(--header-h) + 16px); }
  .price{ white-space:nowrap; }
  .muted{ color:var(--muted); }
</style>

<h1 class="text-3xl font-bold mb-6">–ö–æ—Ä–∑–∏–Ω–∞</h1>

{% if not cart %}
  <div class="card rounded-xl p-6">
    <p class="text-lg">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</p>
    <p class="muted mt-2">–ó–∞–≥–ª—è–Ω–∏—Ç–µ –≤ <a class="underline" href="{{ url_for('menu') }}">–º–µ–Ω—é</a>, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏–∏ –∏ –¥–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ –∫–æ—Ä–∑–∏–Ω—É.</p>
    <a href="{{ url_for('menu') }}" class="inline-block mt-4 px-5 py-3 rounded-xl bg-[color:var(--accent)] text-black font-semibold">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é</a>
  </div>
{% else %}
  <div class="grid lg:grid-cols-3 gap-6">

    <!-- –ü–æ–∑–∏—Ü–∏–∏ -->
    <div class="lg:col-span-2 space-y-4">
      {% for row in cart %}
      <div class="card rounded-xl p-4 cart-row" data-line="{{ loop.index0 }}" data-unit-price="{{ '%.2f'|format(row.unit_price) }}" data-id="{{ row.line_id or '' }}">
        <div class="flex items-start gap-4">
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2">
              <h3 class="font-semibold truncate">{{ row.name }}</h3>
              {% if row.variant %}<span class="text-xs px-2 py-0.5 rounded-full border border-[color:var(--line)]">{{ row.variant }}</span>{% endif %}
            </div>
            <div class="muted text-sm mt-1">{{ row.category }}{% if row.subname %} ¬∑ {{ row.subname }}{% endif %}</div>
          </div>

          <div class="text-right">
            <div class="price font-semibold">{{ '%.2f'|format(row.unit_price) }} —Ä—É–±.</div>
            <div class="muted text-xs">–¶–µ–Ω–∞ –∑–∞ —à—Ç.</div>
          </div>
        </div>

        <div class="mt-3 flex items-center justify-between gap-3">
          <form method="post" action="{{ url_for('cart_update') }}" class="flex items-center gap-3" target="cart-silent">
            <input type="hidden" name="i" value="{{ loop.index0 }}">
            <input type="hidden" name="line_id" value="{{ row.line_id or '' }}">
            <input type="hidden" name="silent" value="1">
            <div class="inline-flex items-center rounded-lg border border-[color:var(--line)] overflow-hidden">
              <button type="button" class="px-3 py-2 select-none js-dec" aria-label="–£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ">‚àí</button>
              <input name="qty" type="number" min="0" value="{{ row.qty }}" class="w-14 text-center bg-transparent outline-none py-2 js-qty" />
              <button type="button" class="px-3 py-2 select-none js-inc" aria-label="–£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ">+</button>
            </div>

          </form>
          <div class="price font-semibold">–ò—Ç–æ–≥–æ: <span class="js-line-total">{{ '%.2f'|format(row.unit_price * row.qty) }}</span> —Ä—É–±.</div>
        </div>

        <div class="mt-3 text-right">
          <button type="button" class="text-red-400 hover:text-red-300 text-sm js-del">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
      {% endfor %}

      <form method="post" action="{{ url_for('cart_clear') }}" class="text-right" target="cart-silent">
        <input type="hidden" name="silent" value="1">
        <button class="text-sm underline text-[color:var(--muted)] hover:text-white">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
      </form>
      <div class="text-right">
        <a href="{{ url_for('menu') }}" class="inline-block text-sm underline">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</a>
      </div>
    </div>

    <!-- –°—É–º–º–∞ –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ -->
    <aside class="lg:col-span-1">
      {% set promo = promo_state or {} %}
      {% set promo_code = promo.promo.code if promo and promo.promo else '' %}
      {% set promo_type = promo.promo.type if promo and promo.promo else '' %}
      {% set promo_value = promo.promo.value if promo and promo.promo else 0 %}
      {% set promo_min = promo.promo.min_subtotal if promo and promo.promo else 0 %}
      {% set promo_status = promo.status if promo else '' %}
      {% set promo_message = promo.message if promo else '' %}
      {% set pickup_pct = site.cart.pickup_discount if site and site.cart and (site.cart.pickup_discount is not none) else 0 %}
      <div class="card rounded-xl p-5 sticky-summary"
           id="cart-summary"
           data-free-from="{{ site.cart.free_from if site and site.cart and (site.cart.free_from is not none) else 1500 }}"
           data-delivery="{{ site.cart.delivery_price if site and site.cart and (site.cart.delivery_price is not none) else 200 }}"
           data-promo-code="{{ promo_code }}"
           data-promo-type="{{ promo_type }}"
           data-promo-value="{{ promo_value }}"
           data-promo-min="{{ promo_min }}"
           data-promo-status="{{ promo_status }}"
           data-promo-message="{{ promo_message }}"
           data-pickup-discount="{{ pickup_pct }}">
        <h2 class="text-xl font-semibold mb-3">–í–∞—à –∑–∞–∫–∞–∑</h2>

        <div class="mb-3 p-3 rounded-lg bg-white/5" id="promo-box">
          {% if promo_code %}
            <div class="flex items-center justify-between gap-2">
              <div>
                <div class="text-sm font-semibold">–ü—Ä–æ–º–æ–∫–æ–¥: {{ promo_code }}</div>
                <div class="text-xs text-[color:var(--muted)]" id="promo-status-text">
                  {% if promo_status == 'ok' %}–ü—Ä–∏–º–µ–Ω—ë–Ω{% elif promo_status == 'pending' %}{{ promo_message or '–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è' }}{% else %}{{ promo_message or '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω' }}{% endif %}
                </div>
              </div>
              <form method="post" action="{{ url_for('cart_apply_promo') }}">
                <input type="hidden" name="action" value="clear">
                <button class="text-xs underline text-red-300">–£–¥–∞–ª–∏—Ç—å</button>
              </form>
            </div>
          {% else %}
            <form method="post" action="{{ url_for('cart_apply_promo') }}" class="flex gap-2">
              <input name="code" class="flex-1 w-full p-3 rounded-lg border border-[color:var(--line)] bg-transparent text-sm" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥">
              <button class="px-3 py-2 rounded-lg bg-[color:var(--accent)] text-black text-sm font-semibold">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </form>
            <div class="text-xs text-[color:var(--muted)] mt-1" id="promo-status-text">{{ promo_message or '' }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          <span class="text-sm">–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</span>
          <div class="mt-2 inline-flex rounded-full bg-[color:var(--line)] p-1 text-sm js-method-group">
            <button type="button"
                    class="js-method-btn px-3 py-1 rounded-full font-medium bg-[color:var(--accent)] text-black"
                    data-val="delivery">
              üöö –î–æ—Å—Ç–∞–≤–∫–∞
            </button>
            <button type="button"
                    class="js-method-btn px-3 py-1 rounded-full font-medium text-white"
                    data-val="pickup">
              üö∂ –°–∞–º–æ–≤—ã–≤–æ–∑{% if pickup_pct and pickup_pct|float > 0 %} (-{{ '%.0f'|format(pickup_pct|float) }}%){% endif %}
            </button>
          </div>
          <div class="hidden">
            <!-- —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ª–æ–≥–∏–∫–æ–π -->
            <label><input type="radio" name="delivery_method" value="delivery" class="js-method" checked></label>
            <label><input type="radio" name="delivery_method" value="pickup" class="js-method"></label>
          </div>
        </div>

        <div class="space-y-2 text-sm">
          <div class="flex justify-between"><span class="muted">–°—É–º–º–∞</span><span class="price"><span id="js-subtotal">{{ '%.2f'|format(subtotal) }}</span> —Ä—É–±.</span></div>
          <div class="flex justify-between"><span class="muted">–°–∫–∏–¥–∫–∞</span><span class="price" id="js-discount">{% if discount and discount>0 %}-{{ '%.2f'|format(discount) }} —Ä—É–±.{% else %}0.00 —Ä—É–±.{% endif %}</span></div>
          <div class="flex justify-between js-pickup-row hidden"><span class="muted">–°–∫–∏–¥–∫–∞ —Å–∞–º–æ–≤—ã–≤–æ–∑</span><span class="price" id="js-pickup-discount">0.00 —Ä—É–±.</span></div>
          <div class="flex justify-between">
            <span class="muted">–î–æ—Å—Ç–∞–≤–∫–∞ <span class="opacity-70">(–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç <span id="js-free-from">{{ '%.2f'|format(site.cart.free_from if site and site.cart and (site.cart.free_from is not none) else 1500) }}</span> —Ä—É–±.)</span></span>
            <span class="price" id="js-delivery-wrap">{% if delivery and delivery > 0 %}<span id="js-delivery">{{ '%.2f'|format(delivery) }}</span> —Ä—É–±.{% else %}–±–µ—Å–ø–ª–∞—Ç–Ω–æ{% endif %}</span>
          </div>
          <div class="h-px bg-[color:var(--line)] my-2"></div>
          <div class="flex justify-between font-semibold text-lg"><span>–ò—Ç–æ–≥–æ</span><span class="price"><span id="js-total">{{ '%.2f'|format(total) }}</span> —Ä—É–±.</span></div>
        </div>

        <form method="post" action="{{ url_for('order_submit') }}" class="mt-4 space-y-3">
          <input type="hidden" name="delivery_method" id="js-delivery-method" value="delivery">
          <label class="block">
            <span class="text-sm">–ò–º—è*</span>
            <input name="name" required class="mt-1 w-full border rounded-lg p-3 bg-transparent border-[color:var(--line)]" />
          </label>
          <label class="block">
            <span class="text-sm">–¢–µ–ª–µ—Ñ–æ–Ω*</span>
            <input name="phone" required class="mt-1 w-full border rounded-lg p-3 bg-transparent border-[color:var(--line)]" />
          </label>
          <label class="block js-address-block">
            <span class="text-sm">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏*</span>
            <textarea name="address" required rows="2" class="mt-1 w-full border rounded-lg p-3 bg-transparent border-[color:var(--line)]"></textarea>
          </label>
          <div class="block js-payment-block">
            <span class="text-sm">–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</span>
            <div class="mt-2 inline-flex rounded-full bg-[color:var(--line)] p-1 text-sm js-pay-group">
              <button type="button"
                      class="js-pay-btn px-3 py-1 rounded-full font-medium bg-[color:var(--accent)] text-black"
                      data-val="card">
                –ö–∞—Ä—Ç–æ–π
              </button>
              <button type="button"
                      class="js-pay-btn px-3 py-1 rounded-full font-medium text-white"
                      data-val="cash">
                –ù–∞–ª–∏—á–Ω—ã–º–∏
              </button>
            </div>
            <div class="hidden">
              <label><input type="radio" name="payment_method" value="card" class="js-pay" checked></label>
              <label><input type="radio" name="payment_method" value="cash" class="js-pay"></label>
            </div>
            <div class="mt-2 space-y-1 hidden js-change-wrap">
              <span class="text-sm">–°–¥–∞—á–∞ —Å —Å—É–º–º—ã</span>
              <input name="change_from" type="number" step="1" min="0" inputmode="decimal" class="w-full border rounded-lg p-3 bg-transparent border-[color:var(--line)]" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5000" />
              <p class="text-xs text-[color:var(--muted)]">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ, –µ—Å–ª–∏ –±—É–¥–µ—Ç–µ –ø–ª–∞—Ç–∏—Ç—å –Ω–∞–ª–∏—á–Ω—ã–º–∏.</p>
            </div>
          </div>
          <label class="block">
            <span class="text-sm">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</span>
            <textarea name="comment" rows="2" class="mt-1 w-full border rounded-lg p-3 bg-transparent border-[color:var(--line)]"></textarea>
          </label>
          <button class="w-full px-5 py-3 rounded-xl bg-[color:var(--accent)] text-black font-semibold">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </form>
      </div>
    </aside>

  </div>
{% endif %}

<iframe name="cart-silent" style="display:none;width:0;height:0;border:0"></iframe>

<script>
(function(){
  function qsa(sel,root){return Array.prototype.slice.call((root||document).querySelectorAll(sel));}
  function fmt(x){try{return (Math.round((x+Number.EPSILON)*100)/100).toFixed(2);}catch(e){return '0.00';}}
  function updateBadges(count){ try{ ['[data-cart-count]','#cart-count','.cart-count'].forEach(function(sel){ qsa(sel,document).forEach(function(el){ el.textContent=String(count); try{el.dataset.cartCount=String(count);}catch(_){}  }); }); }catch(_){ } }

  function computePromo(subtotal){
    var wrap = document.getElementById('cart-summary');
    if(!wrap){ return {discount:0,status:'none',message:''}; }
    var code = wrap.dataset.promoCode || '';
    var status = wrap.dataset.promoStatus || '';
    var type = wrap.dataset.promoType || '';
    var val = parseFloat(wrap.dataset.promoValue || '0');
    var min = parseFloat(wrap.dataset.promoMin || '0');
    var message = wrap.dataset.promoMessage || '';
    var banned = ['invalid','inactive','expired','limit'];
    var discount = 0;
    var effective = status || 'none';
    if(code && banned.indexOf(status) === -1){
      if(subtotal >= min && subtotal > 0){
        discount = type === 'fixed' ? val : subtotal * (val/100);
        effective = 'ok';
      }else{
        effective = 'pending';
      }
    }
    discount = Math.min(Math.max(discount,0), subtotal);
    return {discount: discount, status: effective, message: message};
  }

  function recompute(){
    var rows = qsa('.cart-row');
    var subtotal = 0;
    var totalQty = 0;
    rows.forEach(function(row){
      var up = parseFloat(row.getAttribute('data-unit-price')||'0');
      var qtyEl = row.querySelector('.js-qty');
      var qty = parseInt(qtyEl && qtyEl.value ? qtyEl.value : '0', 10) || 0;
      totalQty += qty;
      var line = up * qty;
      subtotal += line;
      var lt = row.querySelector('.js-line-total');
      if(lt){ lt.textContent = fmt(line); }
    });
    var promoRes = computePromo(subtotal);
    var discount = promoRes.discount || 0;
    var subtotalAfter = Math.max(0, subtotal - discount);

    var sumEl = document.getElementById('js-subtotal'); if(sumEl){ sumEl.textContent = fmt(subtotal); }
    var discEl = document.getElementById('js-discount'); if(discEl){ discEl.textContent = (discount>0 ? ('-' + fmt(discount)) : '0.00') + ' —Ä—É–±.'; }

    var wrap = document.getElementById('cart-summary');
    var hiddenMethod = document.getElementById('js-delivery-method');
    var method = (hiddenMethod && hiddenMethod.value) ? hiddenMethod.value : 'delivery';
    var pickupPct = parseFloat(wrap ? (wrap.getAttribute('data-pickup-discount')||'0') : '0');
    var pickupLine = document.querySelector('.js-pickup-row');
    var pickupValEl = document.getElementById('js-pickup-discount');
    var pickupDiscount = 0;

    var delivery = 0;
    if(wrap){
      var freeFrom = parseFloat(wrap.getAttribute('data-free-from')||'1500');
      var deliveryPrice = parseFloat(wrap.getAttribute('data-delivery')||'200');
      if(method === 'pickup'){
        delivery = 0;
        pickupDiscount = subtotalAfter * (isNaN(pickupPct)?0:pickupPct) / 100;
      }else{
        delivery = (subtotalAfter >= freeFrom && subtotalAfter>0) ? 0 : deliveryPrice;
        pickupDiscount = 0;
      }
      var delWrap = document.getElementById('js-delivery-wrap');
      if(delWrap){ delWrap.innerHTML = (delivery<=0 ? '–±–µ—Å–ø–ª–∞—Ç–Ω–æ' : ('<span id=\"js-delivery\">'+fmt(delivery)+'</span> —Ä—É–±.')); }
    }

    if(pickupLine && pickupValEl){
      if(pickupDiscount > 0){
        pickupLine.classList.remove('hidden');
        pickupValEl.textContent = '-' + fmt(pickupDiscount) + ' —Ä—É–±.';
      }else{
        pickupLine.classList.add('hidden');
        pickupValEl.textContent = '0.00 —Ä—É–±.';
      }
    }

    var totalEl = document.getElementById('js-total'); 
    if(totalEl){ totalEl.textContent = fmt(Math.max(0, subtotalAfter - pickupDiscount + delivery)); }
    updateBadges(totalQty);
  }

  function bind(){
    function currentIndex(row){ var rows=[].slice.call(document.querySelectorAll('.cart-row')); return rows.indexOf(row); }
    // payment toggle (pill buttons + hidden radios)
    (function(){
      var payRadios = qsa('.js-pay');
      var changeWrap = document.querySelector('.js-change-wrap');
      function applyPay(val){
        payRadios.forEach(function(r){ r.checked = (r.value === val); });
        qsa('.js-pay-btn').forEach(function(btn){
          var active = (btn.dataset.val === val);
          btn.classList.toggle('bg-[color:var(--accent)]', active);
          btn.classList.toggle('text-black', active);
          btn.classList.toggle('text-white', !active);
        });
        if(changeWrap){
          var input = changeWrap.querySelector('input[name=\"change_from\"]');
          if(val === 'cash'){
            changeWrap.classList.remove('hidden');
            if(input){ input.required = true; }
          }else{
            changeWrap.classList.add('hidden');
            if(input){ input.required = false; input.value=''; }
          }
        }
      }
      qsa('.js-pay-btn').forEach(function(btn){
        btn.addEventListener('click', function(){ applyPay(btn.dataset.val || 'card'); });
      });
      payRadios.forEach(function(r){
        r.addEventListener('change', function(){ applyPay(r.value || 'card'); });
      });
      var initial = (document.querySelector('.js-pay:checked')||{}).value || 'card';
      applyPay(initial);
    })();

    // delivery method toggle (pill buttons + hidden radios)
    (function(){
      var addr = document.querySelector('.js-address-block textarea[name=\"address\"]');
      var addrWrap = document.querySelector('.js-address-block');
      var payWrap = document.querySelector('.js-payment-block');
      var hidden = document.getElementById('js-delivery-method');

      function applyMethod(method){
        if(hidden){ hidden.value = method; }
        qsa('.js-method').forEach(function(r){ r.checked = (r.value === method); });
        qsa('.js-method-btn').forEach(function(btn){
          var active = (btn.dataset.val === method);
          btn.classList.toggle('bg-[color:var(--accent)]', active);
          btn.classList.toggle('text-black', active);
          btn.classList.toggle('text-white', !active);
        });
        if(method === 'pickup'){
          if(addr){ addr.required = false; addr.value=''; }
          if(addrWrap){ addrWrap.classList.add('hidden'); }
          if(payWrap){ payWrap.classList.add('hidden'); }
        }else{
          if(addr){ addr.required = true; }
          if(addrWrap){ addrWrap.classList.remove('hidden'); }
          if(payWrap){ payWrap.classList.remove('hidden'); }
        }
        recompute();
      }

      qsa('.js-method-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
          applyMethod(btn.dataset.val || 'delivery');
        });
      });
      qsa('.js-method').forEach(function(r){
        r.addEventListener('change', function(){
          applyMethod(r.value || 'delivery');
        });
      });

      var initial = (hidden && hidden.value) || ((document.querySelector('.js-method:checked')||{}).value) || 'delivery';
      applyMethod(initial);
    })();

    document.querySelectorAll('form[action$=\"/cart/update\"]').forEach(function(form){
      form.setAttribute('target','cart-silent');
      if(!form.querySelector('input[name=\"silent\"]')){ var h=document.createElement('input'); h.type='hidden'; h.name='silent'; h.value='1'; form.appendChild(h); }
      var qty = form.querySelector('.js-qty');
      var btnInc = form.querySelector('.js-inc');
      var btnDec = form.querySelector('.js-dec');

      if(btnInc){ btnInc.addEventListener('click', function(){
        if(qty){ qty.value = (parseInt(qty.value||'0',10)||0) + 1; }
        var row = form.closest('.cart-row');
        var iEl = form.querySelector('input[name=\"i\"]'); if(iEl && row){ iEl.value = currentIndex(row); }
        form.submit();
        recompute();
      }); }
      if(btnDec){ btnDec.addEventListener('click', function(){
        if(qty){ qty.value = Math.max(0,(parseInt(qty.value||'0',10)||0) - 1); }
        var row = form.closest('.cart-row');
        var iEl = form.querySelector('input[name=\"i\"]'); if(iEl && row){ iEl.value = currentIndex(row); }
        form.submit();
        if(row && qty && (parseInt(qty.value||'0',10)||0)===0){ row.parentNode.removeChild(row); }
        recompute();
      }); }
      if(qty){
        var t; qty.addEventListener('input', function(){
          var v = parseInt(qty.value||'0',10); if(isNaN(v) || v<0) v = 0; qty.value = v;
          clearTimeout(t);
          t = setTimeout(function(){
            var row = form.closest('.cart-row');
            var iEl = form.querySelector('input[name=\"i\"]'); if(iEl && row){ iEl.value = currentIndex(row); }
            form.submit();
            if(v===0){ var row=form.closest('.cart-row'); if(row){ row.parentNode.removeChild(row); } }
            recompute();
          }, 250);
        });
      }
    });

    document.querySelectorAll('form[action$=\"/cart/clear\"]').forEach(function(f){
      f.setAttribute('target','cart-silent');
      if(!f.querySelector('input[name=\"silent\"]')){ var h=document.createElement('input'); h.type='hidden'; h.name='silent'; h.value='1'; f.appendChild(h); }
      f.addEventListener('submit', function(){
        [].slice.call(document.querySelectorAll('.cart-row')).forEach(function(r){ r.parentNode.removeChild(r); });
        setTimeout(function(){ window.location.href = '{{ url_for('cart') }}'; }, 30);
      });
    });

    // delete buttons emulate qty=0 on the update form
    document.querySelectorAll('.js-del').forEach(function(btn){
      btn.addEventListener('click', function(){
        var row = btn.closest('.cart-row'); if(!row) return;
        var form = row.querySelector('form[action$=\"/cart/update\"]'); if(!form) return;
        var qty = form.querySelector('.js-qty'); if(qty) qty.value = 0;
        var iEl = form.querySelector('input[name=\"i\"]'); if(iEl) iEl.value = currentIndex(row);
        form.submit();
        row.parentNode.removeChild(row);
        setTimeout(function(){
          if(document.querySelectorAll('.cart-row').length===0){ window.location.href = '{{ url_for('cart') }}'; return; }
          recompute();
        }, 30);
      });
    });
  }

  // Initial
  bind();
  recompute();

  // Recompute after server postMessage (badge update)
  window.addEventListener('message', function(e){
    try{ if(e && e.data && e.data.type==='cart_count'){ setTimeout(recompute, 30); } }catch(_){ }
  });
})();
</script>

{% endblock %}
