{% extends 'base.html' %}
{% block title %}Герои главной — {{ site.name or 'Сайт' }}{% endblock %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Герой-блоки (static/hero)</h1>
<p class="text-sm text-[color:var(--muted)] mb-6">
  Добавляйте, удаляйте и меняйте порядок фоновых фото на главной. Для desktop/mobile используйте парные файлы (например,
  <b>hero-mobile.jpg</b> и <b>hero-desktop.jpg</b>). Новые файлы добавятся в конец списка.
</p>

<form method="post" enctype="multipart/form-data" class="mb-6 p-4 border rounded-xl bg-white/5 border-[color:var(--line)]">
  <label class="block text-sm font-medium mb-2">Загрузить изображения (можно несколько):</label>
  <input type="file" name="images" accept="image/*" multiple class="block mb-3">
  <button class="px-5 py-3 rounded-xl bg-black text-white">Загрузить</button>
  <a href="{{ url_for('admin_dashboard') }}" class="ml-4 text-sm underline">← В админку</a>
</form>

{% if files %}
  <div class="space-y-3" id="hero-list">
    {% for f in files %}
      <div class="border rounded-lg overflow-hidden border-[color:var(--line)] flex items-center gap-3 p-3 hero-item" data-name="{{ f.name }}">
        <img src="{{ f.url }}" alt="{{ f.name }}" class="w-32 h-20 object-cover rounded">
        <div class="flex-1 min-w-0">
          <div class="font-semibold truncate" title="{{ f.name }}">{{ f.name }}</div>
          <div class="text-xs text-[color:var(--muted)]">static/hero/{{ f.name }}</div>
        </div>
        <div class="flex flex-col gap-1">
          <button type="button" class="px-3 py-1 border rounded btn-move up" title="Вверх">↑</button>
          <button type="button" class="px-3 py-1 border rounded btn-move down" title="Вниз">↓</button>
        </div>
        <form method="post" action="{{ url_for('admin_hero_delete') }}" onsubmit="return confirm('Удалить {{ f.name }}?')" class="ml-2">
          <input type="hidden" name="name" value="{{ f.name }}">
          <button class="text-red-400 hover:text-red-300 text-sm">Удалить</button>
        </form>
      </div>
    {% endfor %}
  </div>
  <button id="save-order" class="mt-3 px-5 py-3 rounded-xl bg-[color:var(--accent)] text-black font-semibold">Сохранить порядок</button>
{% else %}
  <div class="p-4 border rounded-lg text-sm border-dashed border-[color:var(--line)] text-[color:var(--muted)]">
    Пока нет загруженных изображений. Добавьте файлы выше.
  </div>
{% endif %}

<script>
(function(){
  const list = document.getElementById('hero-list');
  const saveBtn = document.getElementById('save-order');
  if(!list || !saveBtn) return;

  function move(item, dir){
    const sibling = dir === 'up' ? item.previousElementSibling : item.nextElementSibling;
    if(!sibling) return;
    if(dir === 'up'){
      list.insertBefore(item, sibling);
    } else {
      list.insertBefore(sibling, item);
    }
  }

  list.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-move');
    if(!btn) return;
    const item = e.target.closest('.hero-item');
    if(!item) return;
    if(btn.classList.contains('up')) move(item, 'up');
    if(btn.classList.contains('down')) move(item, 'down');
  });

  saveBtn.addEventListener('click', async function(){
    const order = Array.from(list.querySelectorAll('.hero-item')).map((el, idx) => ({
      name: el.dataset.name || '',
      order: idx
    }));
    saveBtn.disabled = true;
    saveBtn.textContent = 'Сохраняем...';
    try{
      const resp = await fetch('/admin/hero/order', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({order: order.map(o => o.name)})
      });
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      const js = await resp.json();
      if(!js.ok) throw new Error(js.error || 'Не удалось сохранить');
      alert('Порядок сохранён');
    }catch(err){
      alert('Ошибка: ' + err.message);
    }finally{
      saveBtn.disabled = false;
      saveBtn.textContent = 'Сохранить порядок';
    }
  });
})();
</script>
{% endblock %}
